#! /bin/sh

M=/sys/kernel/debug/memlayout

usage() {
	echo "usage: dnuma-test all-to <node>"
	echo "       -- moves all memory to the node <node>"
	echo "	     dnuma-test stripe <base-nid> <end-nid> <pfn-per-stripe>"
	echo "       -- stripe memory between nodes <base-nid> and <end-nid>, inclusive"
	echo "       -- For example, \`stripe 1 2 1\` results in 0-0:1,1-1:2,2-2:1,3-3:2"
	exit 1
}

debug () {
	[ -n "$DEBUG" ]
}

dbg () {
	debug && echo "$@"
}

create_rme () {
	# start end node
	local h_start=$(printf "0x%x" "$1") h_end=$(printf "0x%x" "$2")
	dbg "creating rme $h_start $h_end $3"
	echo "$h_start" > $M/start || echo "failed to write $h_start to start"
	echo "$h_end"   > $M/end   || echo "failed to write $h_end to end"
	echo "$3"       > $M/node  || echo "failed to write $3 to node"
}

[ $# -lt 1 ] && usage
act="$1"; shift

high_pfn=$(printf "%d" "0x$(for i in $M/current/*-*; do
				printf "%s" "$(basename "$i" )" | cut -d- -f2
			    done | sort -rn | head -n1)" )

dbg "high_pfn = $high_pfn"

case "$act" in
	# all-to <node id>
a*)	[ $# -ne 1 ] && usage
	create_rme 0 "$high_pfn" "$1"
	echo 1 > $M/commit
	;;
	# stripe <base-nid> <end-nid> <pfn-per-stripe>
s*)	[ $# -ne 3 ] && usage
	base_nid=$1
	end_nid=$2
	pfn_per_stripe=$3

	pfn=0
	nid=$base_nid
	while [ $pfn -lt $high_pfn ] ; do
		: $((next_pfn = pfn + pfn_per_stripe - 1))
		if [ $next_pfn -gt $high_pfn ]; then
			dbg "capping pfn from $next_pfn to $high_pfn"
			next_pfn=$high_pfn
		fi
		create_rme $pfn $next_pfn $nid
		: $((nid = nid + 1))
		if [ $nid -gt $end_nid ]; then
			nid=$base_nid;
		fi
		: $((pfn = next_pfn + 1))
	done
	echo 1 > $M/commit
	;;
*)	usage ;;
esac

