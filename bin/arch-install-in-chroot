#!/bin/bash
# arch just after chroot configuration

USER=y
if ! [ -e /home/"$USER" ]; then
	sudo useradd -m -G wheel "$USER"
fi

# Allow wheel's nopasswd sudo
sudo tee /etc/sudoers.d/50-wheel <<EOF
%wheel ALL=(ALL) NOPASSWD: ALL
EOF

# can't do this on install due to arch-chroot mounting.
#sudo ln -sf /usr/lib/systemd/resolv.conf /etc/resolv.conf
#sudo systemctl restart systemd-resolved

# Make sure our shiny new arch is up-to-date
echo "Checking for system updates..."
sudo pacman -Syuu

# Create a tmp-working-dir and navigate into it
sudo -u "$USER" mkdir -p /tmp/pacaur_install
cd /tmp/pacaur_install

INST=()

# for pacaur
INST+=(binutils make gcc fakeroot)
# for dkms
INST+=(linux-headers)

#
INST+=(grub openssh)

INST+=(htop vim bash-completion ccache)

sudo pacman -S "${INST[@]}" --noconfirm --needed

# Install pacaur dependencies from arch repos
#sudo pacman -S expac yajl git --noconfirm --needed

# Install "cower" from AUR
sudo -u "$USER" curl -o PKGBUILD https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=cower
sudo -u "$USER" makepkg PKGBUILD -s --skippgpcheck --install --needed --noconfirm

# Install "pacaur" from AUR
sudo -u "$USER" curl -o PKGBUILD https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=pacaur
sudo -u "$USER" makepkg PKGBUILD -s --install --needed --noconfirm

sudo -u "$USER" pacaur -S zfs-dkms zfs-auto-snapshot-git --needed --noconfirm --noedit

sudo tee /etc/systemd/network/50-wired.network <<EOF
[Match]
Name=en*

[Network]
DHCP=ipv4
EOF

sudo tee /etc/systemd/system/zpool-scrub@.service <<EOF
[Service]
Type=oneshot
ExecStart=/usr/bin/zpool scrub %
EOF

sudo tee /etc/systemd/system/zpool-scrub@.timer <<EOF
[Timer]
OnCalendar=weekly
Persistent=true

[Install]
WantedBy=timers.target
EOF

sudo systemctl enable zfs.target zfs-import-cache zfs-import-scan zfs-mount zfs-share zfs-zed systemd-resolved systemd-networkd zfs-auto-snapshot-frequent.timer zfs-auto-snapshot-hourly.timer zfs-auto-snapshot-daily.timer zfs-auto-snapshot-weekly.timer zfs-auto-snapshot-monthly.timer sshd.socket

# TODO: enable scrub on each zpool

# Clean up...
cd ~
rm -r /tmp/pacaur_install
